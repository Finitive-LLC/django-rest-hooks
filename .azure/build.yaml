name: 1.0.$(Rev:r)

pr: none
trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - '.azure/*'
pool:
    vmImage: ubuntu-latest
steps:
  - checkout: self

  - task: UsePythonVersion@0
    inputs:
      versionSpec: 3.9
    displayName: Use Python 3.9

  - task: TwineAuthenticate@1
    inputs:
      artifactFeed: 'Finitive/pypy'

  - task: PipAuthenticate@1
    displayName: 'Pip authenticate'
    inputs:
      artifactFeeds: 'pypy'
      onlyAddExtraIndex: True   # 'onlyAddExtraIndex' also populates PIP_EXTRA_INDEX_URL env variable

  - publish: $(Build.SourcesDirectory)
    artifact: src
    displayName: Publish Sourcecode

  - script: |
      python -m venv .env
      source .env/bin/activate
      python -m pip install --upgrade pip
      pip install -r requirements.txt --extra-index-url https://pkgs.dev.azure.com/FinitiveLLC/Finitive/_packaging/pypy/pypi/simple/
    displayName: "Install requirements"
    workingDirectory: $(System.DefaultWorkingDirectory)

  - script: |
      source .env/bin/activate
      pip install -r requirements-dev.txt
      pytest --junitxml=junit/test-results.xml --cov=. --cov-report=xml --cov-report=html
    displayName: "Run Unit test"
    workingDirectory: $(System.DefaultWorkingDirectory)

  - task: PublishTestResults@2
    condition: succeeded()
    inputs:
      testResultsFormat: JUnit
      testResultsFiles: $(System.DefaultWorkingDirectory)/junit/test-*.xml
      testRunTitle: 'Publish test results'

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'


